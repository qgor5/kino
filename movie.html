<!DOCTYPE html> 
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TopKino — Детали фильма</title>
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#111" />
  <style>
    /* Твои стили — оставлены без изменений */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 15px;
    }
    a {
      color: #00aaff;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .poster {
      width: 300px;
      height: 450px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      object-fit: cover;
      background-color: #222;
    }
    .details {
      flex: 1;
      min-width: 280px;
      max-width: 600px;
    }
    .video-wrapper {
      margin: 40px auto 20px;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      cursor: pointer;
    }
    .video-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 64px;
      height: 64px;
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-button::before {
      content: '';
      border-style: solid;
      border-width: 12px 0 12px 20px;
      border-color: transparent transparent transparent white;
    }
    .seo-text {
      background: #1a1a1a;
      padding: 20px;
      margin-top: 40px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      line-height: 1.6;
    }
    .seo-text h2 {
      margin-top: 0;
      color: #00aaff;
    }
    .social-links {
      margin-top: 40px;
      text-align: center;
    }
    .social-links a {
      margin: 0 10px;
    }
    #similarMoviesList ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 50px;
    }
    #similarMoviesList li {
      cursor: pointer;
      width: 140px;
      background: #222;
      border-radius: 8px;
      padding: 10px;
      color: #eee;
      user-select: none;
      text-align: center;
      transition: background 0.3s;
    }
    #similarMoviesList li:hover {
      background: #00aaff;
      color: #111;
    }
    #similarMoviesList img {
      width: 140px;
      height: 180px;
      border-radius: 6px;
      object-fit: cover;
      margin-bottom: 8px;
      pointer-events: none;
      user-select: none;
    }
    #similarMoviesList span {
      font-weight: bold;
      font-size: 14px;
      display: block;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>

  <a href="/index.html">← Назад к списку фильмов</a>

  <div class="container">
    <img class="poster" src="" alt="Постер фильма" />
    <div class="details">
      <h1 class="title"></h1>
      <p class="meta-info" id="releaseDate"></p>
      <p class="meta-info" id="director"></p>
      <p class="meta-info" id="actors"></p>
      <p class="description"></p>
      <p class="meta-info" id="rating"></p>
    </div>
  </div>

  <div class="video-wrapper" id="videoWrapper" style="display:none;">
    <img id="videoThumb" src="" alt="Трейлер" />
    <div class="play-button"></div>
  </div>

  <div class="seo-text" id="seoText"></div>

  <div class="social-links">
    <!-- социальные ссылки оставил без изменений -->
  </div>

  <!-- Похожие фильмы -->
  <div id="similarMoviesList">
    <h2 style="color:#00aaff;">Похожие фильмы</h2>
    <ul></ul>
  </div>

  <script>
    const API_KEY = '7cb67565ace3a08cd9d099c749787121';
    const IMG_URL = 'https://image.tmdb.org/t/p/w500';

    // Универсальная функция для парсинга ID фильма из URL
    function getMovieIdFromURL() {
      const path = location.pathname;
      const parts = path.split('/').filter(Boolean);
      if (parts.length === 0) return null;
      const last = parts[parts.length - 1];
      const idPart = last.split('-')[0];
      if (!idPart || isNaN(idPart)) return null;
      return idPart;
    }

    // Текущий ID фильма
    let movieId = getMovieIdFromURL();

    // Если id нет — редиректим на главную или можно установить дефолтный фильм
    if (!movieId) {
      // Можно сделать редирект или показать ошибку
      alert('Фильм не найден. Переадресация на главную.');
      window.location.href = '/index.html';
    }

    const seoTextEl = document.getElementById('seoText');
    const videoWrapper = document.getElementById('videoWrapper');
    const videoThumb = document.getElementById('videoThumb');

    async function loadMovie() {
      try {
        const movieRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=ru-RU`);
        if (!movieRes.ok) throw new Error('Фильм не найден');

        const movie = await movieRes.json();

        const creditsRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${API_KEY}&language=ru-RU`);
        const credits = await creditsRes.json();

        const director = credits.crew.find(c => c.job === 'Director')?.name || 'Неизвестен';
        const actors = credits.cast.slice(0, 3).map(a => a.name);
        const genres = movie.genres.map(g => g.name);
        const poster = movie.poster_path ? IMG_URL + movie.poster_path : 'https://via.placeholder.com/300x450';

        // Заполняем страницу
        document.querySelector('.poster').src = poster;
        document.querySelector('.title').textContent = `${movie.title} (${movie.release_date.slice(0,4)})`;
        document.getElementById('releaseDate').textContent = `Дата выхода: ${movie.release_date}`;
        document.getElementById('director').textContent = `Режиссёр: ${director}`;
        document.getElementById('actors').textContent = `Актёры: ${actors.join(', ')}`;
        document.querySelector('.description').textContent = movie.overview;
        document.getElementById('rating').textContent = `Рейтинг TMDB: ${movie.vote_average.toFixed(1)} (${movie.vote_count} голосов)`;

        // SEO-текст
        const seoKey = `seo-${movieId}`;
        let seo = localStorage.getItem(seoKey);
        if (!seo) {
          seo = `<h2>${movie.title} — смотреть онлайн</h2>
            <p>Фильм «${movie.title}» в жанре ${genres.join(', ').toLowerCase()} вышел в ${movie.release_date.slice(0, 4)} году. Режиссёр — ${director}. В главных ролях: ${actors.join(', ')}. Сюжет: ${movie.overview}</p>
            <p>Этот проект получил оценку ${movie.vote_average.toFixed(1)} на TMDB на основе ${movie.vote_count} голосов. Если вы любите ${genres.join(', ').toLowerCase()}, этот фильм вам точно понравится.</p>`;
          localStorage.setItem(seoKey, seo);
        }
        seoTextEl.innerHTML = seo;

        // Трейлеры
        const videosRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=ru-RU`);
        const videos = await videosRes.json();
        const trailer = videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');

        if (trailer) {
          renderTrailer(trailer.key);
        } else {
          renderTrailer(null);
        }

        // JSON-LD
        addJsonLd({
          "@context": "https://schema.org",
          "@type": "Movie",
          "name": movie.title,
          "image": poster,
          "description": movie.overview,
          "datePublished": movie.release_date,
          "url": location.href,
          "genre": genres,
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": movie.vote_average.toFixed(1),
            "ratingCount": movie.vote_count.toString(),
            "bestRating": "10",
            "worstRating": "1"
          },
          "director": { "@type": "Person", "name": director },
          "actor": actors.map(name => ({ "@type": "Person", "name": name })),
          "trailer": trailer ? {
            "@type": "VideoObject",
            "name": `Трейлер фильма ${movie.title}`,
            "description": `Официальный трейлер фильма ${movie.title}.`,
            "thumbnailUrl": `https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg`,
            "uploadDate": new Date(movie.release_date).toISOString(),
            "contentUrl": `https://www.youtube.com/watch?v=${trailer.key}`,
            "embedUrl": `https://www.youtube.com/embed/${trailer.key}`
          } : undefined
        });

        loadSimilarMovies();
      } catch (e) {
        alert(e.message);
        // При ошибке — перенаправим на главную, чтобы избежать ошибки обновления
        window.location.href = '/index.html';
      }
    }

    function addJsonLd(json) {
      const oldScript = document.querySelector('script[type="application/ld+json"]');
      if (oldScript) oldScript.remove();
      const script = document.createElement('script');
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(json);
      document.head.appendChild(script);
    }

    function renderTrailer(key) {
      if (!key) {
        videoWrapper.style.display = 'none';
        videoWrapper.onclick = null;
        videoWrapper.innerHTML = '';
        return;
      }
      videoWrapper.style.display = 'block';
      videoThumb.src = `https://img.youtube.com/vi/${key}/hqdefault.jpg`;
      videoWrapper.onclick = () => {
        videoWrapper.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${key}?autoplay=1`;
        iframe.allowFullscreen = true;
        iframe.loading = 'lazy';
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        videoWrapper.appendChild(iframe);
      };
    }

    async function loadSimilarMovies() {
      const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/similar?api_key=${API_KEY}&language=ru-RU&page=1`);
      if (!res.ok) {
        console.error('Не удалось загрузить похожие фильмы');
        return;
      }
      const data = await res.json();
      const listEl = document.querySelector('#similarMoviesList ul');
      listEl.innerHTML = '';
      data.results.slice(0, 7).forEach(movie => {
        const li = document.createElement('li');

        const img = document.createElement('img');
        img.src = movie.poster_path ? IMG_URL + movie.poster_path : 'https://via.placeholder.com/140x180?text=No+Poster';
        img.alt = movie.title;

        const span = document.createElement('span');
        span.textContent = movie.title;

        li.appendChild(img);
        li.appendChild(span);

        li.onclick = () => {
          // Меняем ID и URL без перезагрузки
          movieId = movie.id;
          const newUrl = `/${movie.id}-${movie.title.toLowerCase().replace(/[^a-zа-яё0-9]+/gi, '-')}`;
          history.pushState(null, '', newUrl);
          loadMovie();
          window.scrollTo(0, 0);
        };

        listEl.appendChild(li);
      });
    }

    // Обрабатываем кнопку Назад браузера
    window.onpopstate = () => {
      movieId = getMovieIdFromURL();
      if (!movieId) {
        window.location.href = '/index.html';
        return;
      }
      loadMovie();
    };

    loadMovie();
  </script>

</body>
</html>
