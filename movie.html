<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Загрузка фильма...</title>
  <meta name="description" content="Загрузка..." />
  <meta property="og:type" content="video.movie" />
  <meta property="og:title" content="TopKino — Детали фильма" />
  <meta property="og:description" content="Описание фильма и трейлер онлайн." />
  <meta property="og:image" content="" />
  <meta property="og:url" content="" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:image" content="" />

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPMXGR1HF9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FPMXGR1HF9');
  </script>
</head>
<body style="background:#111;color:#fff;font-family:sans-serif;padding:20px;">
  <h1 id="loading">Загрузка...</h1>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const API_KEY = '7cb67565ace3a08cd9d099c749787121';
      const IMG_URL = 'https://image.tmdb.org/t/p/w500';

      const slug = location.pathname.split('/').pop();
      const movieId = slug.split('-')[0];

      try {
        const [movieRes, creditsRes, videosRes] = await Promise.all([
          fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=ru-RU`),
          fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${API_KEY}&language=ru-RU`),
          fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=ru-RU`)
        ]);

        const movie = await movieRes.json();
        const credits = await creditsRes.json();
        const videos = await videosRes.json();

        const director = credits.crew.find(p => p.job === 'Director')?.name || 'Неизвестен';
        const actors = credits.cast.slice(0, 3).map(a => a.name);
        const genres = movie.genres.map(g => g.name);
        const poster = movie.poster_path ? IMG_URL + movie.poster_path : '';
        const description = movie.overview || 'Описание отсутствует';
        const trailer = videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
        const trailerKey = trailer?.key || '';
        const trailerUploadDate = new Date(movie.release_date).toISOString();

        // Обновляем страницу
        document.title = `${movie.title} (${movie.release_date.slice(0,4)})`;
        document.getElementById('loading').remove();

        document.body.innerHTML += `
          <div style="text-align:center;">
            <img src="${poster}" alt="${movie.title}" style="width:300px;border-radius:8px;" />
            <h1>${movie.title} (${movie.release_date.slice(0,4)})</h1>
            <p><strong>Жанр:</strong> ${genres.join(', ')}</p>
            <p><strong>Режиссёр:</strong> ${director}</p>
            <p><strong>Актёры:</strong> ${actors.join(', ')}</p>
            <p><strong>Рейтинг:</strong> ${movie.vote_average.toFixed(1)} / 10 (${movie.vote_count} голосов)</p>
            <p style="margin-top:20px;">${description}</p>
            ${trailerKey ? `<div style="margin-top:30px;"><iframe width="100%" height="400" src="https://www.youtube.com/embed/${trailerKey}" frameborder="0" allowfullscreen></iframe></div>` : ''}
          </div>
        `;

        // JSON-LD для Google
        const jsonLd = {
          "@context": "https://schema.org",
          "@type": "Movie",
          "name": movie.title,
          "image": poster,
          "description": description,
          "datePublished": movie.release_date,
          "url": location.href,
          "genre": genres,
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": movie.vote_average.toFixed(1),
            "ratingCount": movie.vote_count.toString(),
            "bestRating": "10",
            "worstRating": "1"
          },
          "director": { "@type": "Person", "name": director },
          "actor": actors.map(name => ({ "@type": "Person", "name": name })),
          ...(trailerKey && {
            "trailer": {
              "@type": "VideoObject",
              "name": `Трейлер фильма ${movie.title}`,
              "description": `Официальный трейлер фильма ${movie.title}.`,
              "thumbnailUrl": `https://img.youtube.com/vi/${trailerKey}/hqdefault.jpg`,
              "uploadDate": trailerUploadDate,
              "contentUrl": `https://www.youtube.com/watch?v=${trailerKey}`,
              "embedUrl": `https://www.youtube.com/embed/${trailerKey}`
            }
          })
        };

        const ld = document.createElement('script');
        ld.type = 'application/ld+json';
        ld.textContent = JSON.stringify(jsonLd);
        document.head.appendChild(ld);
      } catch (e) {
        console.error(e);
        document.body.innerHTML = '<h2 style="color:red;text-align:center;">Ошибка загрузки фильма</h2>';
      }
    });
  </script>
</body>
</html>
