<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TopKino — Детали фильма</title>
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#111" />
  <meta name="description" content="Смотрите трейлер, описание и подробности фильма онлайн." />

  <!-- Open Graph -->
  <meta property="og:type" content="video.movie" />
  <meta property="og:title" content="TopKino — Детали фильма" />
  <meta property="og:description" content="Смотрите трейлер, описание и подробности фильма онлайн." />
  <meta property="og:image" content="https://image.tmdb.org/t/p/w500/poster.jpg" />
  <meta property="og:url" content="https://topkino.netlify.app/" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TopKino — Детали фильма" />
  <meta name="twitter:description" content="Фильм онлайн. Трейлер, описание, актёры, рейтинг." />
  <meta name="twitter:image" content="https://image.tmdb.org/t/p/w500/poster.jpg" />

  <!-- Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPMXGR1HF9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FPMXGR1HF9');
  </script>

  <style>/* Стили как у тебя — не трогал */</style>
</head>
<body>
  <!-- Страница как у тебя: постер, описание, трейлер и т.д. -->

  <!-- JavaScript ниже автоматизирует всё -->
  <script>
    const API_KEY = '7cb67565ace3a08cd9d099c749787121';
    const IMG_URL = 'https://image.tmdb.org/t/p/w500';
    let movieId = location.pathname.split('/').pop().split('-')[0];

    async function loadMovie() {
      const movieRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=ru-RU`);
      if (!movieRes.ok) return;
      const movie = await movieRes.json();

      const creditsRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${API_KEY}&language=ru-RU`);
      const credits = await creditsRes.json();

      const director = credits.crew.find(p => p.job === 'Director')?.name || 'Неизвестен';
      const actors = credits.cast.slice(0, 3).map(a => a.name);
      const genres = movie.genres.map(g => g.name);
      const poster = movie.poster_path ? IMG_URL + movie.poster_path : 'https://via.placeholder.com/300x450';
      const description = movie.overview;

      // Обновляем title и meta
      document.title = `${movie.title} (${movie.release_date.slice(0,4)}) — Смотреть онлайн`;
      const metaDesc = document.querySelector('meta[name="description"]');
      metaDesc.content = `${movie.title} (${movie.release_date.slice(0,4)}): ${description.slice(0,160)}`;

      // Open Graph + Twitter
      const ogTags = {
        'og:title': `${movie.title} (${movie.release_date.slice(0,4)})`,
        'og:description': description,
        'og:image': poster,
        'og:url': location.href,
        'twitter:title': `${movie.title} (${movie.release_date.slice(0,4)})`,
        'twitter:description': description,
        'twitter:image': poster
      };
      for (const [prop, content] of Object.entries(ogTags)) {
        let meta = document.querySelector(`meta[property="${prop}"], meta[name="${prop}"]`);
        if (!meta) {
          meta = document.createElement('meta');
          if (prop.startsWith('og:')) meta.setAttribute('property', prop);
          else meta.setAttribute('name', prop);
          document.head.appendChild(meta);
        }
        meta.setAttribute('content', content);
      }

      // Трейлер
      const videoRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=ru-RU`);
      const videos = await videoRes.json();
      const trailer = videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
      const trailerKey = trailer?.key || '';
      const trailerUploadDate = new Date(movie.release_date).toISOString();

      // JSON-LD
      const jsonLd = {
        "@context": "https://schema.org",
        "@type": "Movie",
        "name": movie.title,
        "image": poster,
        "description": description,
        "datePublished": movie.release_date,
        "url": location.href,
        "genre": genres,
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": movie.vote_average.toFixed(1),
          "ratingCount": movie.vote_count.toString(),
          "bestRating": "10",
          "worstRating": "1"
        },
        "director": { "@type": "Person", "name": director },
        "actor": actors.map(name => ({ "@type": "Person", "name": name })),
        ...(trailerKey && {
          "trailer": {
            "@type": "VideoObject",
            "name": `Трейлер фильма ${movie.title}`,
            "description": `Официальный трейлер фильма ${movie.title}.`,
            "thumbnailUrl": `https://img.youtube.com/vi/${trailerKey}/hqdefault.jpg`,
            "uploadDate": trailerUploadDate,
            "contentUrl": `https://www.youtube.com/watch?v=${trailerKey}`,
            "embedUrl": `https://www.youtube.com/embed/${trailerKey}`
          }
        })
      };

      const old = document.querySelector('script[type="application/ld+json"]');
      if (old) old.remove();
      const script = document.createElement('script');
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(jsonLd);
      document.head.appendChild(script);
    }

    loadMovie();
  </script>
</body>
</html>
