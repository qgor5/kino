<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TopKino — Детали фильма</title>
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#111" />

  <!-- Google Tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPMXGR1HF9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FPMXGR1HF9');
  </script>

  <style>
    body {
      margin: 0; font-family: Arial, sans-serif;
      background: #111; color: #eee; padding: 15px;
    }
    a { color: #00aaff; text-decoration: none; margin-bottom: 20px; display: inline-block; }
    .container {
      display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
    }
    .poster {
      width: 300px; height: 450px; border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      object-fit: cover; background-color: #222;
    }
    .details {
      flex: 1; min-width: 280px; max-width: 600px;
    }
    .video-wrapper {
      margin: 40px auto 20px;
      width: 100%; max-width: 800px; aspect-ratio: 16 / 9;
      position: relative; border-radius: 8px;
      overflow: hidden; background: #000; cursor: pointer;
    }
    .video-wrapper img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .play-button {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 64px; height: 64px;
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .play-button::before {
      content: '';
      border-style: solid;
      border-width: 12px 0 12px 20px;
      border-color: transparent transparent transparent white;
    }
    .seo-text {
      background: #1a1a1a; padding: 20px; margin-top: 40px;
      border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
      line-height: 1.6;
    }
    .seo-text h2 {
      margin-top: 0; color: #00aaff;
    }
    .social-links {
      margin-top: 40px; text-align: center;
    }
    .social-links a {
      margin: 0 10px;
    }
    #similarMoviesList ul {
      list-style:none; padding:0; display:flex; flex-wrap:wrap;
      gap:15px; justify-content:center;
    }
    #similarMoviesList li {
      cursor: pointer;
      width: 140px; background: #222; border-radius: 8px;
      padding: 10px; color: #eee; user-select: none;
      text-align: center; transition: background-color 0.3s;
    }
    #similarMoviesList li:hover {
      background-color: #333;
    }
    #similarMoviesList img {
      width: 140px; height: 180px; border-radius: 6px;
      object-fit: cover; margin-bottom: 8px; pointer-events: none;
    }
  </style>
</head>
<body>

  <a href="/index.html">← Назад к списку фильмов</a>

  <div class="container">
    <img class="poster" src="" alt="Постер фильма" />
    <div class="details">
      <h1 class="title"></h1>
      <p id="releaseDate"></p>
      <p id="director"></p>
      <p id="actors"></p>
      <p class="description"></p>
      <p id="rating"></p>
    </div>
  </div>

  <div class="video-wrapper" id="videoWrapper" style="display:none;">
    <img id="videoThumb" src="" alt="Трейлер" />
    <div class="play-button"></div>
  </div>

  <div class="seo-text" id="seoText"></div>

  <div class="social-links">
    <!-- соцсети тут по твоему коду -->
  </div>

  <div id="similarMoviesList" style="margin-top:50px; text-align:center;">
    <h2 style="color:#00aaff;">Похожие фильмы</h2>
    <ul></ul>
  </div>

  <script>
    const API_KEY = '7cb67565ace3a08cd9d099c749787121';
    const IMG_URL = 'https://image.tmdb.org/t/p/w500';
    let movieId = location.pathname.split('/').pop().split('-')[0];

    const seoTextEl = document.getElementById('seoText');

    let jsonLdScript = null;

    async function loadMovie() {
      const movieRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=ru-RU`);
      const movie = await movieRes.json();

      const creditsRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${API_KEY}&language=ru-RU`);
      const credits = await creditsRes.json();

      const director = credits.crew.find(p => p.job === 'Director')?.name || 'Неизвестен';
      const actors = credits.cast.slice(0, 5).map(a => a.name);
      const genres = movie.genres.map(g => g.name);
      const poster = movie.poster_path ? IMG_URL + movie.poster_path : 'https://via.placeholder.com/300x450';

      // Заполняем страницу
      document.querySelector('.poster').src = poster;
      document.querySelector('.title').textContent = `${movie.title} (${movie.release_date ? movie.release_date.slice(0,4) : '----'})`;
      document.getElementById('releaseDate').textContent = `Дата выхода: ${movie.release_date || 'неизвестна'}`;
      document.getElementById('director').textContent = `Режиссёр: ${director}`;
      document.getElementById('actors').textContent = `Актёры: ${actors.join(', ') || 'информация отсутствует'}`;
      document.querySelector('.description').textContent = movie.overview || 'Описание отсутствует.';
      document.getElementById('rating').textContent = `Рейтинг TMDB: ${movie.vote_average ? movie.vote_average.toFixed(1) : '-'} (${movie.vote_count || 0} голосов)`;

      // SEO текст
      const seoKey = `seo-${movieId}`;
      let seo = localStorage.getItem(seoKey);
      if (!seo) {
        seo = `<h2>${movie.title} — смотреть онлайн</h2>
          <p>Фильм «${movie.title}» в жанре ${genres.join(', ').toLowerCase()} вышел в ${movie.release_date ? movie.release_date.slice(0, 4) : 'неизвестном'} году. Режиссёр — ${director}. В главных ролях: ${actors.join(', ')}. Сюжет: ${movie.overview}</p>
          <p>Оценка ${movie.vote_average ? movie.vote_average.toFixed(1) : '–'} на TMDB (${movie.vote_count || 0} голосов). Если любите ${genres.join(', ').toLowerCase()} — обязательно посмотрите.</p>`;
        localStorage.setItem(seoKey, seo);
      }
      seoTextEl.innerHTML = seo;

      // Удаляем предыдущий JSON-LD
      if (jsonLdScript) {
        jsonLdScript.remove();
        jsonLdScript = null;
      }

      // Загружаем видео для JSON-LD
      const videosRes = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=ru-RU`);
      const videosData = await videosRes.json();
      const trailer = videosData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');

      // Формируем расширенный JSON-LD
      const schema = {
        "@context": "https://schema.org",
        "@type": "Movie",
        "name": movie.title,
        "image": poster,
        "description": movie.overview || '',
        "datePublished": movie.release_date || '',
        "url": location.href,
        "genre": genres,
        "inLanguage": "ru",
        "director": {
          "@type": "Person",
          "name": director
        },
        "actor": actors.map(name => ({
          "@type": "Person",
          "name": name
        })),
        "aggregateRating": (movie.vote_count && movie.vote_average) ? {
          "@type": "AggregateRating",
          "ratingValue": movie.vote_average.toFixed(1),
          "ratingCount": movie.vote_count,
          "bestRating": "10",
          "worstRating": "1"
        } : undefined,
        "publisher": {
          "@type": "Organization",
          "name": "TopKino",
          "url": "https://topkino.netlify.app/",
          "logo": {
            "@type": "ImageObject",
            "url": "https://topkino.netlify.app/logo.png"
          }
        }
      };

      if (trailer) {
        schema.trailer = {
          "@type": "VideoObject",
          "name": `${movie.title} — официальный трейлер`,
          "description": `Трейлер фильма ${movie.title}`,
          "thumbnailUrl": `https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg`,
          "uploadDate": trailer.published_at || '', // если есть, иначе ''
          "contentUrl": `https://www.youtube.com/watch?v=${trailer.key}`,
          "embedUrl": `https://www.youtube.com/embed/${trailer.key}`,
          "publisher": {
            "@type": "Organization",
            "name": "TopKino",
            "url": "https://topkino.netlify.app/"
          }
        };
      }

      // Очистка undefined полей
      function clean(obj) {
        for (const key in obj) {
          if (obj[key] === undefined || obj[key] === null) {
            delete obj[key];
          } else if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
            clean(obj[key]);
          }
        }
      }
      clean(schema);

      jsonLdScript = document.createElement('script');
      jsonLdScript.type = 'application/ld+json';
      jsonLdScript.textContent = JSON.stringify(schema);
      document.head.appendChild(jsonLdScript);
    }

    async function loadTrailer() {
      const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=ru-RU`);
      const data = await res.json();
      const trailer = data.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
      if (trailer) {
        const wrapper = document.getElementById('videoWrapper');
        const thumb = document.getElementById('videoThumb');
        thumb.src = `https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg`;
        wrapper.style.display = 'block';
        wrapper.onclick = () => {
          wrapper.innerHTML = ''; // очищаем превью
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${trailer.key}?autoplay=1`;
          iframe.allowFullscreen = true;
          iframe.loading = 'lazy';
          iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          wrapper.appendChild(iframe);
        };
      } else {
        document.getElementById('videoWrapper').style.display = 'none';
      }
    }

    async function loadSimilarMovies() {
      const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/similar?api_key=${API_KEY}&language=ru-RU&page=1`);
      const data = await res.json();
      const listEl = document.querySelector('#similarMoviesList ul');
      listEl.innerHTML = '';
      data.results.slice(0,7).forEach(movie => {
        const li = document.createElement('li');
        li.onclick = () => {
          movieId = movie.id;
          history.pushState(null, '', `/${movie.id}-${movie.title.toLowerCase().replace(/[^a-zа-яё0-9]+/g, '-')}`);
          loadMovie();
          loadTrailer();
          loadSimilarMovies();
          window.scrollTo(0, 0);
        };
        li.innerHTML = `
          <img src="${movie.poster_path ? IMG_URL + movie.poster_path : 'https://via.placeholder.com/140x180?text=No+Poster'}" alt="${movie.title}">
          <span style="font-weight:bold;">${movie.title}</span>
        `;
        listEl.appendChild(li);
      });
    }

    loadMovie();
    loadTrailer();
    loadSimilarMovies();

    window.onpopstate = () => {
      movieId = location.pathname.split('/').pop().split('-')[0];
      loadMovie();
      loadTrailer();
      loadSimilarMovies();
    };
  </script>

</body>
</html>
